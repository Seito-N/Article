---
title: "OECDパッケージを使ってデータ分析"
emoji: "⭐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["R", "OECD"]
published: false
---

# 記事について

この記事は R アドベントカレンダー 22 日目の記事です。

`{OECD}` パッケージを使ってデータを取得し、分析する方法について紹介します。この記事では各国の GDP を取得して可視化するところまでを扱います。

# OECDパッケージとは

## 目的

OECD のデータを検索し、抽出することができます。CRANの文書は[こちら](https://cran.r-project.org/web/packages/OECD/OECD.pdf)にあります。

## 使用の流れ

以下 3 つのプロセスに分けて紹介します。

1.  `{OECD}` パッケージのインストール
2.  データの取得
3.  加工と可視化

# `{OECD}` パッケージのインストール

まずは `{OECD}` パッケージをインストールします。その後、どのような関数がこのパッケージに含まれるかを見てみます。

## バージョンを指定してインストール

`{OECD`} パッケージの最新バージョンにはバグの出る関数があります（GitHub 上に [Issues](https://github.com/expersso/OECD/issues/24) が立てられています）。そのためここでは `{devtools}` パッケージを使って 1 つ古いバージョンをインストールします。

本記事の公開日（2022-12-22）時点での最新バージョンは `'0.2.5'` ですが、`'0.2.4'` を指定してインストールします。

```{r}
devtools::install_version("OECD", version = "0.2.4")
```

バージョン `0.2.4` がインストールできたかを念のため確認します。

```{r}
packageVersion("OECD")
```

大丈夫でした。次に進みます。

    [1] ‘0.2.4’

## パッケージを覗く

パッケージがインストールできたので、具体的にどのような関数が含まれるかを見てみます。

まずは `library` 関数で `{OECD}` パッケージを取得します。後で使用する別のパッケージもここで取得しておきます。

```{r}
library(OECD)
library(tidyverse)
```

`{OECD}` パッケージに含まれる関数は以下のとおりです。いかにもデータをゲットできそうです。

なおこの後使う関数は `search_dataset`、`get_data_structure`、`get_dataset` の 3 つです。

    browse_metadata         Browse the metadata related to a series.
    get_data_structure      Get the data structure of a dataset.
    get_dataset             Download OECD data sets.
    get_datasets            Get a data frame with information on all available datasets.
    search_dataset          Search codes and descriptions of available OECD series.

# データを取得する

データの取得は大きく 3 つのプロセスで構成されます。

1.  データの検索
2.  メタデータの確認
3.  データ取得

## データの検索

実際にどのようなデータがあるかを調べます。

データの検索を行うには `search_dataset` 関数を使用します。今回は各国の GDP を調べたいので、"Economic outlook" という文字列を入力して検索しました。

どのようなワードで検索すれば良いか分からない場合は [OECD Stat](https://stats.oecd.org/) を直接見に行くのが良いかもしれません。例えば以下画像の検索画面で Economic Projections $\rightarrow$ OECD Economic Outlook $\rightarrow$ OECD Economic Outlook Latest edition $\rightarrow$ Economic Outlook No 112 - November 2022 と進めばお目当てのデータにたどり着くことができます（この辺りは慣れが必要な部分でもあると思います）。

![OECDstat](./Article/articles/OECD.PNG)

```{r}
search_dataset(string = "Economic Outlook")
```

結果の一部を表示しています。今回は一番下の `EO112_INTERNET` のデータセットを使用します。

          id              title
    6     EO78_MAIN       Economic Outlook No 78 - December 2005 - Annual Projections for OECD Countries
    9     EO78_TRADE      Economic Outlook No 78 - December 2005 - Annual Trade and Payments Projections
    12    EO77_MAIN       Economic Outlook No 77 - June 2005 - Annual Projections for OECD Countries
    14    EO77_TRADE      Economic Outlook No 77 - June 2005 - Annual Trade and Payments Projections
    64    EO110_INTERNET  Economic Outlook No 110 - December 2021.
    1549  EO112_INTERNET  Economic Outlook No 112 - November 2022.

## メタデータの確認

データセットのすべての行を取得するとサイズが大きいので、データセットの中で必要な箇所だけを取得します。

そのためにはまず、今回使用するデータのメタデータを取得します。関数に与えるのはデータセットの `title` ではなく `id` です。

```{r}
metadata <- get_data_structure("SNA_TABLE1")
```

`VAR_DESC` にアクセスすると、メタデータの中に何が入っているかが分かります。`LOCATION` から `REFERENCEPERIOD` までで 10 個の `List` が入っています。

```{r}
metadata$VAR_DESC
```

    > metadata$VAR_DESC
                    id        description
    1         LOCATION            Country
    2         VARIABLE           Variable
    3        FREQUENCY          Frequency
    4             TIME               Time
    5        OBS_VALUE  Observation Value
    6      TIME_FORMAT        Time Format
    7       OBS_STATUS Observation Status
    8             UNIT               Unit
    9        POWERCODE    Unit multiplier
    10 REFERENCEPERIOD   Reference period

各 `List` はデータフレームになっています。一部覗いてみます。

`LOCATION` には国名が入っています。

```{r}
metadata$LOCATION %>% head()
```

       id     label
    1 AUS Australia
    2 AUT   Austria
    3 BEL   Belgium
    4 CAN    Canada
    5 CHL     Chile
    6 COL  Colombia

`FREQUENCY` には年次データなのか、四半期データなのかの分類があります。

```{r}
metadata$FREQUENCY
```

    > metadata$FREQUENCY
      id     label
    1  A    Annual
    2  Q Quarterly

このような流れで、概ねどのような形でデータを取得すれば良さそうかアタリを付けていきます。

<https://www.supplychaindataanalytics.com/oecd-gdp-data-analysis-in-r/>

## データの取得

データの取得に使用する関数は `get_dataset` です。引数の `filter`、 `start_time`、`end_time` を指定して必要な箇所だけを取得します。

今回は以下のデータを取得しました。

-   国は G7（カナダ、フランス、ドイツ、イタリア、日本、英国、米国） と OECD
-   集計期間は年次
-   1974 年から 2021 年まで（高度経済成長期以降）

```{r}
dat_gdp_df <- get_dataset(dataset = "SNA_TABLE1",
                          filter = list(c("JPN", "CAN", "FRA", 
                                          "DEU", "ITA", "GBR", "USA"), 
                                        "B1_GA", 
                                        "CXC"), 
                          start_time = 1974, end_time = 2021)
```

```{r}
dat_gdp_df %>% 
  rename(`国` = LOCATION,
         `年` = obsTime, 
         GDP = obsValue) %>% 
  group_by(`国`) %>% 
  mutate(`年` = as.double(`年`), 
         label = if_else(`年` == max(`年`), `国`, NA_character_)) %>% 
  ggplot(data = ., 
         mapping = aes(x = `年`, y = GDP, color = `国`)) + 
  geom_point(show.legend = TRUE) + 
  geom_line(show.legend = TRUE) + 
  geom_label_repel(mapping = aes(label = label), nudge_x = Inf,
                   na.rm = TRUE, show.legend = FALSE) + 
  scale_y_continuous(labels = unit_format(unit = "M"),
                     breaks = seq(0, 24000000, by = 2000000)) +
  scale_x_continuous(breaks = seq(1974, 2021, by = 5)) + 
  coord_cartesian(xlim = c(1974, 2025), expand = TRUE) + 
  labs(title = "GDPの国際比較 USD")
```
