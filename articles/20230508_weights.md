---
title: ""
emoji: "🔖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [R, Stata, データ分析]
published: false
bibliography: [./references/references.bib]
---

# 本記事の目的

この記事では、データ分析を行う際に考慮するウエイト（weight）について簡単に整理します。
後半では Stata と R の結果を比較しながら実際の中身を確認していきます。

# Stata で選択できる 4 つのコマンド

Stata には以下のようなウエイトコマンドがあります。

-   `fweight`: freqency weight
-   `aweight`: analytic weight
-   `pweight`: probablity weight
-   `iweight`: importance weight

それぞれの数式上の意味合いや違い、共通点を見ていきます。

なお、`iweight` は特殊なオプションということでこの記事ではそれ以外の 3 つを扱います。

# 各ウエイトの説明

まず結論として、各ウエイトでそもそも意味が異なります。
説明は [Dupraz (2013)](https://www.parisschoolofeconomics.eu/docs/dupraz-yannick/using-weights-in-stata(1).pdf) を参考にしています。

まず結論としては、どのオプションを使用しても点推定値には違いがありません。異なるのは標準誤差が異なります。

## fweight 

`fweight` が使用されるのは、1 つのデータセットに重複したデータが入っているようなケースです。例えば、以下のような形で $i$ 行目が重複しています。

$$
\boldsymbol{X}=\begin{bmatrix}
1 & x_{11} & \cdots & x_{1k} \\
\vdots & \vdots & \vdots & \vdots \\
1 & x_{i1} & \cdots & x_{ik} \\
1 & x_{i1} & \cdots & x_{ik} \\
\vdots & \vdots & \vdots & \vdots \\
1 & x_{n1} & \cdots & x_{nk}
\end{bmatrix}

,\ 

\boldsymbol{y}=\begin{bmatrix}
y_1\\
\vdots\\
y_i\\
y_i\\
\vdots\\
y_{n}
\end{bmatrix}
$$

この時の回帰係数の分散共分散行列は以下のとおりです。回帰係数の分散は以下のように求められます。残差分散 $\hat{u}^\mathrm{t}\hat{u}$ を割っている $n-(k+1)$ のところが通常の回帰係数の分散共分散行列にはないところです。

$$
\sum=\frac{\hat{u}^\mathrm{t}\hat{u}}{n-(k+1)}(\boldsymbol{X^\mathrm{t}\boldsymbol{X}})^{-1}
$$

## aweight

ここでは以下のモデルを推定することを想定します。
$$
y_{ij}=T_j\tau+x_j\beta+u_{ij}
$$

$i$ は 個人を、$j$ はグループを表現しています。$y_{ij}$ と $u_{ij}$ は個人単位ですが、説明変数は添え字が $j$ であり、グループ単位になっています。

ここでは、計算効率及びランダムなのはグループ単位であるという理由から、以下の式を推定したいと考えます。

$$
\bar{y}_j=T_j\tau+x_j\beta+\bar{u}_{i}
$$

この式を `aweight` で推定したとき、点推定値は `fweight` と一致します。異なるのは標準誤差で、標準誤差は以下の式であらわされます。

`fweight` は分母が $n-(k+1)$ でした。$n$ は重複アリのデータセットの行数です。ここでの $m$ はグループやクラスタの数を表しています。

$$
\sum=\frac{\hat{u}^\mathrm{t}\hat{u}}{m-(k+1)}(\boldsymbol{X^\mathrm{t}\boldsymbol{X}})^{-1}
$$

## pweight

最後に `pweight` は、ある母集団からの異なる抽出確率に対してかけるウエイトです。例えば論文の中では都市と地方の研究対象者がおり、都市では 2 人に 1 人が抽出され、地方では 10 人に 1 人が抽出された状況を想定しています。この場合、都市では 1 人の対象者が 2 人分の、地方では 10 人分の重みもつことになります。

この場合、


# コードで再現

```stata:stata
reg aaa iii
```

# R で再現

そもそもなぜ


R では `lm` 関数に `weights` という関数がついています。

# 参考

Dupraz, Y. (2013). Using weights in Stata. Accessed on August.
