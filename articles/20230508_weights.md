---
title: "Stata ã¨ R ã® weight(s) ã‚ªãƒ—ã‚·ãƒ§ãƒ³"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [R, Stata, ãƒ‡ãƒ¼ã‚¿åˆ†æ, ã‚¦ã‚¨ã‚¤ãƒˆ]
published: false
bibliography: [./references/references.bib]
---

# æœ¬è¨˜äº‹ã®ç›®çš„

ã“ã®è¨˜äº‹ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’è¡Œã†éš›ã«è€ƒæ…®ã™ã‚‹ã‚¦ã‚¨ã‚¤ãƒˆï¼ˆweightï¼‰ã«ã¤ã„ã¦æ•´ç†ã—ã¾ã™ã€‚å¾ŒåŠã§ã¯ Stata ã¨ R ã®çµæœã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚èª¬æ˜ã¯ [Dupraz (2013)](https://www.parisschoolofeconomics.eu/docs/dupraz-yannick/using-weights-in-stata(1).pdf) ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚è‰²ã€…ã¨çœç•¥ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚‚ã‚ã‚‹ã®ã§ã€è©³ç´°ã¯å¿…è¦ã«å¿œã˜ã¦å…ƒè«–æ–‡ã‚’ã”è¦§ãã ã•ã„ã€‚

# Stata ã§é¸æŠå¯èƒ½ãª 4 ã¤ã® `*weight` ã‚ªãƒ—ã‚·ãƒ§ãƒ³

Stata ã«ã¯ 4 ã¤ã® weight ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

-   `fweight`: frequency weights
-   `aweight`: analytic weights
-   `pweight`: probability weights
-   `iweight`: importance weights

ï¼ˆ`iweight` ã¯ç‰¹æ®Šãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã®ã“ã¨ã§ã€ã“ã®è¨˜äº‹ã§ã¯ãã‚Œä»¥å¤–ã® 3 ã¤ã‚’æ‰±ã„ã¾ã™ï¼‰

# å„ã‚¦ã‚¨ã‚¤ãƒˆã®èª¬æ˜

çµè«–ã¨ã—ã¦ã€ã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚‚ç‚¹æ¨å®šå€¤ã«ã¯é•ã„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç•°ãªã‚‹ã®ã¯æ¨å®šå€¤ã®æ¨™æº–èª¤å·®ã§ã™ã€‚

## fweight 

`fweight` ãŒæƒ³å®šã™ã‚‹ã®ã¯ã€1 ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«é‡è¤‡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã§ã¯ $i$ è¡Œç›®ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚

$$
\boldsymbol{X}=\begin{bmatrix}
1 & x_{11} & \cdots & x_{1k} \\
\vdots & \vdots & \vdots & \vdots \\
1 & x_{i1} & \cdots & x_{ik} \\
1 & x_{i1} & \cdots & x_{ik} \\
\vdots & \vdots & \vdots & \vdots \\
1 & x_{n1} & \cdots & x_{nk}
\end{bmatrix},\  
\boldsymbol{y}=\begin{bmatrix}
y_1\\
\vdots\\
y_i\\
y_i\\
\vdots\\
y_{n}
\end{bmatrix}
$$

`fweight` ã§æ¨å®šã—ãŸå›å¸°ä¿‚æ•°ã®åˆ†æ•£å…±åˆ†æ•£è¡Œåˆ—ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚$n$ ã¯ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®è¡Œæ•°ã€$k$ ã¯èª¬æ˜å¤‰æ•°ã®æ•°ã§ã™ã€‚æ®‹å·®åˆ†æ•£ $\hat{u}^\mathrm{t}\hat{u}$ ã‚’ $n-(k+1)$ ã§å‰²ã£ã¦ã„ã¾ã™

$$
\sum=\frac{\hat{u}^\mathrm{t}\hat{u}}{n-(k+1)}(\boldsymbol{X^\mathrm{t}\boldsymbol{X}})^{-1}
$$

## aweight

ã“ã“ã§ã¯ä»¥ä¸‹ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ¨å®šã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¾ã™ã€‚

$$
y_{ij}=T_j\tau+x_j\beta+u_{ij}
$$

$i$ ã¯ å€‹äººã€$j$ ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚$y_{ij}$ ã¨ $u_{ij}$ ã¯å€‹äººå˜ä½ã§ç•°ãªã‚Šã¾ã™ãŒã€èª¬æ˜å¤‰æ•°ã¯æ·»ãˆå­—ãŒ $j$ ã§ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§ã™ã€‚ã¾ãŸã“ã“ã§ã¯ã€è¨ˆç®—åŠ¹ç‡ãŠã‚ˆã³ãƒ©ãƒ³ãƒ€ãƒ ãªã®ã¯ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§ã‚ã‚‹ã¨ã„ã†ç†ç”±ã‹ã‚‰ã€ä»¥ä¸‹ã®å¼ã‚’æ¨å®šã™ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™ã€‚

$$
\bar{y}_j=T_j\tau+x_j\beta+\bar{u}_{i}
$$

ä¸Šè¿°ã®ã¨ãŠã‚Šã€ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’ `aweight` ã§æ¨å®šã™ã‚‹ã¨ç‚¹æ¨å®šå€¤ã¯ `fweight` ã¨ä¸€è‡´ã—ã¾ã™ã€‚ç•°ãªã‚‹ã®ã¯æ¨™æº–èª¤å·®ã§ã€åˆ†æ•£å…±åˆ†æ•£è¡Œåˆ—ã¯ä»¥ä¸‹ã®å¼ã§è¡¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã® $m$ ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ã®æ•°ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚$\tilde{u}$ ã®ä¸Šã«ã¤ã„ã¦ã„ã‚‹è¨˜å·ï¼ˆãƒãƒ«ãƒ€ï¼‰ã¯é‡ã¿ã¥ã‘ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

$$
\sum=\frac{\tilde{\hat{u}}^\mathrm{t}\tilde{\hat{u}}}{m-(k+1)}(\tilde{\boldsymbol{X}}^\mathrm{t}\tilde{\boldsymbol{X}})^{-1}
$$

## pweight

`pweight` ã¯æ¯é›†å›£ã‹ã‚‰ã®æŠ½å‡ºç¢ºç‡ã‚’åæ˜ ã™ã‚‹ã‚¦ã‚¨ã‚¤ãƒˆã§ã™ã€‚å‚è€ƒã«ã—ãŸè«–æ–‡ã®ä¾‹ã§ã¯ã€éƒ½å¸‚åœã¨åœ°æ–¹ã®èª¿æŸ»å¯¾è±¡è€…ãŒãŠã‚Šã€éƒ½å¸‚åœã§ã¯ 2 äººã« 1 äººãŒã€åœ°æ–¹ã§ã¯ 10 äººã« 1 äººãŒæŠ½å‡ºã•ã‚ŒãŸçŠ¶æ³ãŒæƒ³å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å ´åˆã€éƒ½å¸‚åœã§ã¯ 1 äººã®å¯¾è±¡è€…ãŒ 2 äººåˆ†ã®ã€åœ°æ–¹ã§ã¯ 10 äººåˆ†ã®é‡ã¿ã‚‚ã¡ã¾ã™ã€‚ã“ã®é‡ã¿ã‚’è€ƒæ…®ã—ãªã„åˆ†æã‚’è¡Œã†ã¨ã€åˆ†æçµæœã«éƒ½å¸‚åœã®æ„è¦‹ãŒå®Ÿæ…‹ã‚ˆã‚Šå¤§ããåæ˜ ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

`pweight` ã§å®Ÿè¡Œã—ãŸçµæœã‚‚å›å¸°ä¿‚æ•°ã®ç‚¹æ¨å®šå€¤ã¯ `aweight`ã€`fweight` ã¨åŒã˜ã§ã™ãŒã€ã“ã“ã§ã‚‚ã‚„ã¯ã‚Šæ¨™æº–èª¤å·®ã®çµæœãŒç•°ãªã‚Šã¾ã™ã€‚`pweight` ã®æ¨™æº–èª¤å·®ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼ˆSandwich Estimaterï¼‰ã€‚$\boldsymbol{W}$ ã¯ $m \times m$ ã®å¯¾è§’è¡Œåˆ—ã§ã€å¯¾è§’æˆåˆ†ã«ã¯å„ã‚°ãƒ«ãƒ¼ãƒ—ã«ãŠã‘ã‚‹æ®‹å·®ã® 2 ä¹—ï¼ˆ$\hat{u}_j^2$ï¼‰ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

$$
\sum=\frac{m}{m-(k+1)}(\tilde{\boldsymbol{X}}^\mathrm{t}\tilde{\boldsymbol{X}})^{-1}(\tilde{\boldsymbol{X}}^\mathrm{t}\boldsymbol{W}\tilde{\boldsymbol{X}})(\tilde{\boldsymbol{X}}^\mathrm{t}\tilde{\boldsymbol{X}})^{-1}
$$



# ãƒ‡ãƒ¼ã‚¿ã§å†ç¾

ã“ã“ã§ã¯ `aweight` ã¨ `pweight` ã‚’ä½¿ã£ã¦å®Ÿéš›ã«åˆ†æã—ã¦ã¿ã¾ã™ã€‚

## æ‰±ã†ãƒ‡ãƒ¼ã‚¿

PISA 2018ï¼ˆOECD ã«ã‚ˆã‚‹ç”Ÿå¾’ã®å­¦ç¿’åˆ°é”åº¦èª¿æŸ»ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ [PISA 2018 Database](https://www.oecd.org/pisa/data/2018database/) ã‹ã‚‰å–å¾—ã—ã€`dat_pisa` ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

æ‰±ã£ãŸå¤‰æ•°ã¯ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã†ã¡ã®ä¸€éƒ¨ã§ã€æ•°å­¦çš„ãƒªãƒ†ãƒ©ã‚·ãƒ¼ã€èª­è§£åŠ›ã€ç”Ÿå¾’ã®ã‚¦ã‚¨ã‚¤ãƒˆã§ã™ã€‚ã‚¦ã‚¨ã‚¤ãƒˆã‚’è€ƒæ…®ã—ã€èª­è§£åŠ›ï¼ˆ`PV1READ`ï¼‰ã‚’ç‹¬ç«‹å¤‰æ•°ã€æ•°å­¦çš„ãƒªãƒ†ãƒ©ã‚·ãƒ¼ï¼ˆ`PV1MATH`ï¼‰ã‚’å¾“å±å¤‰æ•°ã¨ã—ã¦åˆ†æã—ã¾ã™ã€‚

```R:R
> dat_pisa %>% head()
# A tibble: 6 Ã— 3
  PV1MATH PV1READ W_FSTUWT
    <dbl>   <dbl>    <dbl>
1    704.    705.     166.
2    581.    570.     166.
3    692.    648.     166.
4    628.    672.     166.
5    682.    672.     166.
6    784.    770.     166.
```

::: message

ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã™ã“ã¨ã‚’ç›®çš„ã¨ã—ã€åˆ†æç”¨ã®ç°¡æ˜“ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚å…ƒãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã€æ­£ã—ã„ä½¿ã„æ–¹ç­‰ã¯å…¬å¼æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

:::

## Stata

`aweight`ã¨ `pweight` ã§å›å¸°ä¿‚æ•°ï¼ˆCoefficientï¼‰ã®å€¤ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ä¸€æ–¹ã€æ¨™æº–èª¤å·®ï¼ˆStd. err.ï¼‰ã®å€¤ã¯ `pweight` ã®æ–¹ãŒå¤§ãããªã£ã¦ã„ã¾ã™ã€‚è«–æ–‡ã§ã¯ `aweight` ã‹ã¤ robust standard errorï¼ˆãƒ­ãƒã‚¹ãƒˆæ¨™æº–èª¤å·®ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ `pweight` ã®çµæœã¨ä¸€è‡´ã™ã‚‹ã¨è¨˜è¼‰ãŒã‚ã‚Šã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã‚‚è©¦ã—ã¦ã„ã¾ã™ã€‚

:::details aweight

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```
reg pv1math pv1read [aweight=w_fstuwt]
```

çµæœã¯ã“ã¡ã‚‰ã€‚

```
. reg pv1math pv1read [aweight=w_fstuwt]
(sum of wgt is 1,078,921.3259125)
------------------------------------------------------------------------------
     pv1math | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     pv1read |   .7102128    .006849   103.70   0.000     .6967865    .7236392
       _cons |   171.1731   3.510538    48.76   0.000     164.2912    178.0549
------------------------------------------------------------------------------
```
:::

<details>

<summary> pweight </summary>

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```
reg pv1math pv1read [pweight=w_fstuwt]
```
çµæœã¯ã“ã¡ã‚‰ã€‚

```
. reg pv1math pv1read [pweight=w_fstuwt]
------------------------------------------------------------------------------
             |               Robust
     pv1math | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     pv1read |   .7102128    .007116    99.81   0.000      .696263    .7241627
       _cons |   171.1731   3.714015    46.09   0.000     163.8923    178.4538
------------------------------------------------------------------------------

```

</details>

<details>

<summary> aweight + robust standard error </summary>

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```
reg pv1math pv1read [aweight=w_fstuwt], vce(robust)
```

çµæœã¯ã“ã¡ã‚‰ã€‚

```
. reg pv1math pv1read [aweight=w_fstuwt], vce(robust)
(sum of wgt is 1,078,921.3259125)
------------------------------------------------------------------------------
             |               Robust
     pv1math | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     pv1read |   .7102128    .007116    99.81   0.000      .696263    .7241627
       _cons |   171.1731   3.714015    46.09   0.000     163.8923    178.4538
------------------------------------------------------------------------------
```
</details>


## R

R ã§ã¯ `lm` é–¢æ•°ã§ `weights` ã¨ã„ã†å¼•æ•°ã‚’è¨­å®šã§ãã¾ã™ã€‚`W_FSTUWT` ã‚’æŒ‡å®šã—ã¦åˆ†æã™ã‚‹ã¨çµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚Stata ã§ `aweight` ã‚’æŒ‡å®šã—ãŸã¨ãã¨åŒã˜çµæœã«ãªã£ã¦ã„ã¾ã™ã€‚

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```R
model_pisa <- dat_pisa %>% 
  lm(data = ., 
     formula = PV1MATH ~ PV1READ, weights = W_FSTUWT)

summary(model_pisa)
```

çµæœã¯ã“ã¡ã‚‰ï¼ˆä¸€éƒ¨çœç•¥ï¼‰ã€‚

```R
Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
PV1READ       0.710213   0.006849  103.70   <2e-16 ***
(Intercept) 171.173051   3.510538   48.76   <2e-16 ***
```

ã¾ãŸã€`{lmtest}` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†ã¨ãƒ­ãƒã‚¹ãƒˆæ¨™æº–èª¤å·®ãŒè¨ˆç®—ã§ãã¾ã™ã€‚ [Replicating Stata's "robust" option in R](https://stats.stackexchange.com/questions/117052/replicating-statas-robust-option-in-r) ã‚’è¦‹ã‚‹ã¨ã€`type` å¼•æ•°ã§ `HC1` ã‚’è¨­å®šã™ã‚‹ã¨ Stata ã®çµæœã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã§ã™ã€‚

å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```R
lmtest::coeftest(x = model_pisa, vcov. = vcovHC, type = "HC1")
```

çµæœã¯ã“ã¡ã‚‰ã€‚`pweight` ã®çµæœã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚

```
t test of coefficients:

              Estimate Std. Error t value  Pr(>|t|)    
PV1READ       0.710213   0.007116  99.805 < 2.2e-16 ***
(Intercept) 171.173051   3.714015  46.088 < 2.2e-16 ***
```

::: message

Stata ã¨ R ã®çµæœã‚’æ¯”è¼ƒã—ã‚„ã™ã„ã‚ˆã†ã«è¡Œã®ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆãŸã‚Šã€ä¸€éƒ¨çœç•¥ã—ã¦ã„ã¾ã™ã€‚

:::

# å‚è€ƒ

Dupraz, Y. (2013). Using weights in Stata. Accessed on August.